{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h1>Browse Workout Plans</h1>
    <table id="workoutPlanTable" class="table table-striped">
        <thead>
            <tr>
                <th>Name</th>
                <th>Exercises</th>
                <th>Actions</th> <!-- Add the Actions header -->
            </tr>
        </thead>
        <tbody>
            <!-- Workout plan data will be loaded here -->
        </tbody>
    </table>
</div>

<!-- Edit Workout Plan Modal -->
<div class="modal fade" id="editWorkoutPlanModal" tabindex="-1" aria-labelledby="editWorkoutPlanModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editWorkoutPlanModalLabel">Edit Workout Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editWorkoutPlanForm">
                    <!-- Form fields will be dynamically populated here -->
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveWorkoutPlanChanges">Save Changes</button>
            </div>
        </div>
    </div>
</div>


<script>
    $(document).ready(function() {
        var table = $('#workoutPlanTable').DataTable({
            ajax: '/fitness/exercises-and-workouts/get-workout-plans',
            columns: [
                { data: 'name' },
                {
                    data: 'exercises',
                    render: function(data, type, row) {
                        return data.map(exercise => exercise.name).join(', ');
                    }
                },
                {
                    data: 'id',
                    render: function(data, type, row) {
                        return '<button class="btn btn-primary edit-btn" data-id="' + data + '" data-bs-toggle="modal" data-bs-target="#editWorkoutPlanModal">Edit</button>' +
                               '<button class="btn btn-danger delete-btn" data-id="' + data + '">Delete</button>';
                    },
                    orderable: false
                }
            ]
        });
    
        // Open edit modal and load data
        $('#workoutPlanTable').on('click', '.edit-btn', function() {
            var workoutPlanId = $(this).data('id');
            $('#editWorkoutPlanModal').data('workoutPlanId', workoutPlanId);
            $.ajax({
                url: '/fitness/exercises-and-workouts/get-workout-plan/' + workoutPlanId,
                type: 'GET',
                success: function(response) {
                    var formHtml = '<div class="mb-3"><label for="workoutPlanName" class="form-label">Workout Plan Name</label>' +
                                   '<input type="text" class="form-control" id="workoutPlanName" name="name" value="' + response.name + '"></div>';
                    
                    formHtml += '<div class="mb-3"><label class="form-label">Exercises</label>';
                    response.exercises.forEach(function(exercise) {
                        formHtml += '<div class="form-check">' +
                                    '<input class="form-check-input" type="checkbox" value="' + exercise.id + '" id="exercise' + exercise.id + '" name="exercises" checked>' +
                                    '<label class="form-check-label" for="exercise' + exercise.id + '">' +
                                    exercise.name +
                                    '</label></div>';
                    });
                    formHtml += '</div>';
                    $('#editWorkoutPlanModal').find('#editWorkoutPlanForm').html(formHtml);
                    $('#editWorkoutPlanModal').modal('show');
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching workout plan:', status, error);
                }
            });
        });
    
        // Handle form submission for saving changes
        $('#saveWorkoutPlanChanges').click(function() {
            var workoutPlanId = $('#editWorkoutPlanModal').data('workoutPlanId');
            var editedData = {
                name: $('#workoutPlanName').val(),
                exercises: $('#editWorkoutPlanForm input[name="exercises"]:checked').map(function() {
                    return $(this).val();
                }).get()
            };
            
            $.ajax({
                url: '/fitness/exercises-and-workouts/update-workout-plan/' + workoutPlanId,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(editedData),
                success: function(response) {
                    $('#editWorkoutPlanModal').modal('hide');
                    table.ajax.reload();
                },
                error: function(xhr, status, error) {
                    console.error('Error saving changes:', status, error);
                }
            });
        });
    
        // Event listener for Delete button
        $('#workoutPlanTable').on('click', '.delete-btn', function() {
            var workoutPlanId = $(this).data('id');
            if (confirm('Are you sure you want to delete this workout plan?')) {
                $.ajax({
                    url: '/fitness/exercises-and-workouts/delete-workout-plan/' + workoutPlanId,
                    type: 'DELETE',
                    success: function(response) {
                        table.ajax.reload();
                    },
                    error: function(xhr, status, error) {
                        console.error('Error deleting workout plan:', status, error);
                    }
                });
            }
        });
    });
    </script>
    
{% endblock %}
