{% extends 'base.html' %} {% block content %}
<div class="container mt-4">
  <h1>Browse Meals</h1>
  <table id="mealsTable" class="table">
    <thead>
      <tr>
        <th>Meal Name</th>
        <th>Food Items</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for meal in meals %}
      <tr>
        <td>{{ meal.name }}</td>
        <td>{{ meal.food_items }}</td>
        <td>
          <button
            type="button"
            class="btn btn-info show-macros-btn"
            data-id="{{ meal.id }}"
          >
            Show Macros
          </button>
          <button
            type="button"
            class="btn btn-primary edit-meal-btn"
            data-id="{{ meal.id }}"
          >
            Edit
          </button>
          <button
            type="button"
            class="btn btn-danger delete-meal-btn"
            data-id="{{ meal.id }}"
          >
            Delete
          </button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<!-- View Macro Modal -->
<div
  class="modal fade"
  id="macrosModal"
  tabindex="-1"
  role="dialog"
  aria-labelledby="macrosModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="macrosModalLabel">
          Nutritional Information
        </h5>
        <button
          type="button"
          class="close"
          data-dismiss="modal"
          aria-label="Close"
        >
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!-- Nutritional info will be populated here -->
        <div id="macrosContent"></div>
      </div>
    </div>
  </div>
</div>
<!-- Edit Meal Modal -->
<div class="modal fade" id="editMealModal" tabindex="-1" role="dialog" aria-labelledby="editMealModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editMealModalLabel">Edit Meal</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="editMealForm">
                <div class="modal-body">
                    <!-- Dynamic fields for editing meal items will be populated here -->
                    <div id="editMealContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
  $(document).ready(function () {
    $("#mealsTable").DataTable();

    // Bind click event to delete buttons dynamically
    $("#mealsTable").on("click", ".delete-meal-btn", function () {
      var mealId = $(this).data("id");
      console.log("Meal ID to delete:", mealId); // Debugging line
      if (confirm("Are you sure you want to delete this meal?")) {
        $.ajax({
          url: "/nutrition/meals-and-foods/delete-meal/" + mealId,
          method: "POST",
          success: function (response) {
            alert("Meal deleted successfully");
            location.reload(); // Reload the page to reflect the changes
          },
          error: function (xhr, status, error) {
            alert("Error deleting meal: " + xhr.responseText);
          },
        });
      }
    });
  });
</script>

<script>
  $("#mealsTable").on("click", ".show-macros-btn", function () {
    var mealId = $(this).data("id");

    $.ajax({
      url: "/nutrition/meals-and-foods/get-macros/" + mealId,
      method: "GET",
      success: function (data) {
        // Populate the modal with data
        $("#macrosContent").html(data);
        $("#macrosModal").modal("show");
      },
      error: function () {
        alert("Error fetching nutritional information");
      },
    });
  });
</script>

<script>
// Existing JavaScript code...

// Bind click event to edit buttons dynamically
$("#mealsTable").on("click", ".edit-meal-btn", function () {
    var mealId = $(this).data("id");

    // Store mealId in the modal's data
    $('#editMealModal').data('meal-id', mealId);

    // AJAX request to fetch meal data for editing
    $.ajax({
        url: "/nutrition/meals-and-foods/get-meal/" + mealId,
        method: "GET",
        success: function (mealData) {
            // Populate the edit modal
            populateEditModal(mealData);
            $('#editMealModal').modal('show');
        },
        error: function () {
            alert("Error fetching meal data for editing");
        }
    });
});

function populateEditModal(mealData) {
    var editContent = $('#editMealContent');
    editContent.empty();  // Clear existing content

    var htmlContent = '<div class="form-group"><label>Meal Name</label><input type="text" class="form-control" id="editMealName" value="' + mealData.name + '"></div>';
    htmlContent += '<div class="form-group"><label>Food Items</label>';

    mealData.food_items.forEach(function(foodItem) {
        htmlContent += '<div class="row mb-2"><div class="col-6">' + foodItem.name + '</div>';
        htmlContent += '<div class="col-6"><input type="number" class="form-control" value="' + foodItem.serving_count + '" data-food-id="' + foodItem.id + '"></div></div>';
    });

    htmlContent += '</div>';
    editContent.html(htmlContent);
}

$("#mealsTable").on("click", ".edit-meal-btn", function () {
    var mealId = $(this).data("id");

    $.ajax({
        url: "/nutrition/meals-and-foods/get-meal/" + mealId,
        method: "GET",
        success: function (mealData) {
            populateEditModal(mealData);
            $('#editMealModal').modal('show');
        },
        error: function () {
            alert("Error fetching meal data for editing");
        }
    });
});


$('#editMealForm').on('submit', function(e) {
    e.preventDefault();

    // Retrieve mealId from the modal's data
    var mealId = $('#editMealModal').data('meal-id');
    var updatedMealName = $('#editMealName').val();
    var updatedFoodItems = [];

    $('#editMealContent').find('input[data-food-id]').each(function() {
        var foodId = $(this).data('food-id');
        var servingCount = $(this).val();
        updatedFoodItems.push({ id: foodId, serving_count: servingCount });
    });

    var updatedMealData = {
        name: updatedMealName,
        food_items: updatedFoodItems
    };

    $.ajax({
        url: "/nutrition/meals-and-foods/update-meal/" + mealId,
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(updatedMealData),
        success: function(response) {
            alert("Meal updated successfully");
            $('#editMealModal').modal('hide');
            location.reload(); // Reload the page to reflect the changes
        },
        error: function() {
            alert("Error updating meal");
        }
    });
});


function collectUpdatedMealData() {
    // Code to collect updated meal data from the form...
    // This includes the meal name and updated food items and serving sizes
    return updatedMealData;
}

</script>

{% endblock %}
